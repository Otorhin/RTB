exec(open("./modules/adventure/room/mobs.py" , encoding='utf-8').read())
exec(open("./modules/adventure/room/manager.py" , encoding='utf-8').read())


def get_adv_item(adv, user_id):
    _item_lists = names.list_item[adv]
    _store = db.get_user_inventory(user_id)
    _hero = db.get_hero(user_id)
    _quest = db.get_quest(user_id)

    if 'change' in temp[user_id]:
        temp[user_id]['change'] += 0.01
    else:
        temp[user_id]['change'] = 0.01
        if _hero['guild_id']:
            _guild = db.get_guild(_hero['guild_id'])
            temp[user_id]['change'] += int(_guild['build3']) * 0.01

    _item_list = _item_lists[0]

    if random.random() < (0.6 + temp[user_id]['change'] ):
        _item_list = _item_list + _item_lists[1]
    if random.random() < (0.4 + temp[user_id]['change'] ):
        _item_list = _item_list + _item_lists[2]
        if adv == 'forest':
            if int(_quest['allquest']) > 15:
                _item_list.append('lost_cargo')
    if random.random() < (0.2 + temp[user_id]['change'] ):
        _item_list = _item_list + _item_lists[3]
        if adv == 'mount':
            if int(_quest['allquest']) > 13 and int(_quest['allquest']) < 15:
                _item_list.append('snowflower')

    random.shuffle(_item_list)
    random.shuffle(_item_list)
    random_item = random.choice(_item_list)

    return (random_item)

def get_adv_mob(adv, user_id):
    _hero = db.get_hero(user_id)
    _new_rating = (get_atk(user_id) / 2) + (get_def(user_id) / 10) + (int(_hero['hp']) / 10)

    if adv in ['forest', 'mount']:
        _mob_list = [*gcfg.mobs[adv]['easy']]
        if _new_rating > 40:
            _mob_list = [*gcfg.mobs[adv]['medium']]
        if _hero['rating'] > 250 or _new_rating > 55:
            _mob_list += [*gcfg.mobs[adv]['hard']]
    else:
        _mob_list = ['Mummy', 'Scorpio', 'Camel']
    random.shuffle(_mob_list)
    _mob = random.choice(_mob_list)
    return(_mob)

def _in_adventure(user_id, message):
    text = '–¢—ã –∑–∞–Ω—è—Ç –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ–º.'
    send_message(user_id, text)


def adventure_header(user_id):
    _hero = db.get_hero(user_id)
    text = '{gold}üí∞ | {diamond}üíé | {rating}üèÜ'.format(**_hero)
    text += '\n'
    return (text)


class adventure():

    @staticmethod
    def header(user_id):
        _hero = db.get_hero(user_id)
        text = '{}üí∞ | {}üíé\n'.format(_hero['gold'], _hero['diamond'])
        return (text)

    @staticmethod
    def choice(user_id):
        _hero = db.get_hero(user_id)
        _quest = db.get_quest(user_id)
        text = '–í—ã–±–µ—Ä–∏ –∫—É–¥–∞ –ø–æ–π–¥–µ—à—å –Ω–∞ —ç—Ç–æ—Ç —Ä–∞–∑?'
        text += '\n\nüå≤–õ–µ—Å - —Å–ø–æ–∫–æ–π–Ω—ã–π –∏ —Ç–∏—Ö–∏–π –ø–æ—Ö–æ–¥ –∑–∞ —Ä–µ—Å—É—Ä—Å–∞–º–∏.'
        button = [['üå≤–õe—Å'], ['‚¨ÖÔ∏è–ù–∞–∑–∞–¥']]
        if int(_quest['allquest']) > 10:
            text += '\n\nüóª–ì–æ—Ä—ã - —Å–ª–µ–≥–∫–∞ —Ä–∏—Å–∫–æ–≤–∞–Ω–Ω—ã–π –ø–æ—Ö–æ–¥ –∑–∞ –±–æ–ª–µ–µ —Ü–µ–Ω–Ω—ã–º–∏ —Ä–µ—Å—É—Ä—Å–∞–º–∏. –ò–Ω–æ–≥–¥–∞ –º–æ–∂–Ω–æ –Ω–∞—Ç–∫–Ω—É—Ç—Å—è –Ω–∞ –æ–∑–ª–æ–±–ª–µ–Ω–Ω–æ–≥–æ –º–æ–Ω—Å—Ç—Ä–∞.'
            button[0].append('üóª–ì–æ—Ä—ã')
        if int(_quest['allquest']) > 24:
            button[0].append('üèú–ü—É—Å—Ç—ã–Ω—è')
        send_message(user_id, text, button)
        set_hand(user_id, adventure.choice_handler)


    @staticmethod
    def choice_handler(user_id, message):
        _hero = db.get_hero(user_id)
        _quest = db.get_quest(user_id)
        if message == '‚¨ÖÔ∏è–ù–∞–∑–∞–¥':
            start_game(user_id)
        elif message == 'üå≤–õ–µ—Å' or message == 'üå≤–õe—Å' :
            forest_adventure.enter(user_id)
            if _quest['monster'] and _quest['monster'] == 'forest':
                db.change_quest(user_id,quest = _quest['quest'], monster = _quest['monster'], killed = int(_quest['killed']) + 1, need = _quest['need'], allquest = _quest['allquest'])
        elif message == 'üóª–ì–æ—Ä—ã' and int(_quest['allquest']) > 10:
            mount_adventure.enter(user_id)
            if _quest['monster'] and _quest['monster'] == 'mount':
                db.change_quest(user_id,quest = _quest['quest'], monster = _quest['monster'], killed = int(_quest['killed']) + 1, need = _quest['need'], allquest = _quest['allquest'])
        elif message == 'üèú–ü—É—Å—Ç—ã–Ω—è' and int(_quest['allquest']) > 24:
            desert_adventure.enter(user_id)
            if _quest['monster'] and _quest['monster'] == 'desert':
                db.change_quest(user_id,quest = _quest['quest'], monster = _quest['monster'], killed = int(_quest['killed']) + 1, need = _quest['need'], allquest = _quest['allquest'])
        else:
            pass

    @staticmethod
    def random_item(user_id):
        pass


class forest_adventure():

    @staticmethod
    def enter(user_id):
        forest_adventure.item_timer(user_id)
        text = '–¢—ã —É—à–µ–ª –ø—Ä–æ–≥—É–ª—è—Ç—Å—è –ø–æ –ª–µ—Å—É. –ù–∞–¥–µ—é—Å—å, —á—Ç–æ –≤—ã–π–¥–µ—à—å –æ—Ç—Ç—É–¥–∞ –Ω–µ —Å –ø—É—Å—Ç—ã–º–∏ —Ä—É–∫–∞–º–∏.'
        button = [['–û–∂–∏–¥–∞—Ç—å'], ['–í–µ—Ä–Ω—É—Ç—å—Å—è –¥–æ–º–æ–π']]
        send_message(user_id, text, button)
        temp[user_id] = {}
        _skill = db.get_skill(user_id)
        temp[user_id]['count_item'] = round(int(_skill['bag']) * 2,5)
        temp[user_id]['bag'] = []
        temp[user_id]['gold'] = 0

    @staticmethod
    def random_item(user_id):
        _skill = db.get_skill(user_id)
        if temp[user_id]['count_item'] == 0 or len(temp[user_id]['bag']) == int(_skill['bag']):
            if len(temp[user_id]['bag']) == 0:
                text = '–¢—ã –≤–µ—Ä–Ω—É–ª—Å—è –¥–æ–º–æ–π —Å –ø—É—Å—Ç—ã–º–∏ —Ä—É–∫–∞–º–∏.\n–ù–∏—á–µ–≥–æ, –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ –±—É–¥–µ—Ç –ª—É—á—à–µ.'
            else:
                text = '–¢—ã –ø—Ä–∏–Ω–µ—Å –¥–æ–º–æ–π —Å–ª–µ–¥—É—é—â–∏–µ –ø—Ä–µ–¥–º–µ—Ç—ã:\n'
                _data = {}
                for _item in temp[user_id]['bag']:
                    if _item in _data:
                        _data[_item] += 1
                    else:
                        _data[_item] = 1
                for _item in _data:
                    text += '{} x{}\n'.format(names.item[_item], _data[_item])
                if temp[user_id]['gold'] != 0:
                    text += '\n{}üí∞'.format(temp[user_id]['gold'])
            send_message(user_id, text, get_start_button(user_id))
            temp[user_id] = {}
            return

        temp[user_id]['count_item'] -= 1
        text = random.choice(names.advent_text['forest'])
        send_message(user_id, text)
        print ('user_id : ' + str(user_id) + ' | Action: Get /catch | Time : ' + str(time.time()))
        print ('|--------------------|')
        set_hand(user_id, forest_adventure.item_handler)
        bd_adventure2.append(['forest_adventure.item_timer', 20, [user_id]])

    @staticmethod
    def item_timer(user_id):
        set_hand(user_id, forest_adventure.forest_handler)
        time = random.randint(40, 100)
        bd_adventure2.append(['forest_adventure.random_item', time, [user_id]])

    @staticmethod
    def item_handler(user_id, message):
        if message.lower() == '/catch':
            set_hand(user_id, forest_adventure.forest_handler)
            random_item = get_adv_item('forest', user_id)
            text = random.choice(names.advent_text['item']).format(names.item[random_item])

            if (random.random() < 0.05):
                _quest = db.get_quest(user_id)
                if _quest['item'] != random_item:
                    text = '–¢—ã –Ω–∞—à–µ–ª **{}**, –Ω–æ –æ–Ω —Ä–∞—Å—Å—ã–ø–∞–ª—Å—è –ø—Ä—è–º–æ —É —Ç–µ–±—è –≤ —Ä—É–∫–∞—Ö.\n–°–º–∞—Ö–Ω—É–≤ —Å–ª–µ–∑—É, —Ç—ã —Ä–µ—à–∏–ª –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ.'.format(names.item[random_item])
                    send_message(user_id, text, parse_mode = 'Markdown')
                    return

            if random.random() < 0.15:
                if get_atk(user_id) > 20:
                    monster_battle(user_id, get_adv_mob('forest', user_id))
                    return

            if random.random() < 0.075:
                text = random.choice(names.advent_text['diamond_item']).format(names.item[random_item])
                send_sticker(user_id, 'CAADAgADXwADP1c0Gk1PS2oDPWnTAg')
                i_get_diamond(user_id, 1)
            if random.random() > 0.8:
                _gold = i_get_gold(user_id)
                text += '\n–¢–∞–∫–∂–µ —Ç—ã –Ω–∞—à–µ–ª –ø–æ–¥ –Ω–æ–≥–∞–º–∏ {}üí∞.'.format(_gold)
                temp[user_id]['gold'] += _gold
            send_message(user_id, text, parse_mode = 'Markdown')
            temp[user_id]['bag'].append(random_item)
            db.add_inventory(user_id, random_item, 1)
        elif message.lower() == '–≤–µ—Ä–Ω—É—Ç—å—Å—è –¥–æ–º–æ–π':
            temp[user_id]['count_item'] = 0
            text = '–¢—ã –≤—ã–¥–≤–∏–Ω—É–ª—Å—è –¥–æ–º–æ–π.'
            send_message(user_id, text, parse_mode = 'Markdown')
        else:
            return

    @staticmethod
    def forest_handler(user_id, message):
        if message == '/catch':
            text = random.choice(names.advent_text['not_item'])
        elif message.lower() == '–æ–∂–∏–¥–∞—Ç—å':
            text = '–ù—É —Ç—ã –æ–∂–∏–¥–∞–µ—à—å, –Ω–æ –ø–æ–∫–∞ —É—Å–ø–µ—Ö–æ–≤ —ç—Ç–æ —Ç–µ–±–µ –Ω–µ –¥–∞–ª–æ.'
        elif message.lower() == '–≤–µ—Ä–Ω—É—Ç—å—Å—è –¥–æ–º–æ–π':
            text = '–¢—ã –≤—ã–¥–≤–∏–Ω—É–ª—Å—è –¥–æ–º–æ–π.'
            temp[user_id]['count_item'] = 0
        else:
            return
        send_message(user_id, text)


class mount_adventure():

    @staticmethod
    def enter(user_id):
        mount_adventure.item_timer(user_id)
        _skill = db.get_skill(user_id)
        text = '–¢—ã —É—à–µ–ª –ø—Ä–æ–≥—É–ª—è—Ç—å—Å—è –ø–æ –≥–æ—Ä–∞–º. –ù–∞–¥–µ—é—Å—å, —á—Ç–æ –≤—ã–π–¥–µ—à—å –æ—Ç—Ç—É–¥–∞ –Ω–µ —Å –ø—É—Å—Ç—ã–º–∏ —Ä—É–∫–∞–º–∏.'
        button = [['–û–∂–∏–¥–∞—Ç—å'], ['–í–µ—Ä–Ω—É—Ç—å—Å—è –¥–æ–º–æ–π']]
        send_message(user_id, text, button)
        temp[user_id] = {}
        _skill = db.get_skill(user_id)
        temp[user_id]['count_item'] = round(int(_skill['bag']) * 2,5)
        temp[user_id]['bag'] = []
        temp[user_id]['gold'] = 0

    @staticmethod
    def random_item(user_id):
        _skill = db.get_skill(user_id)
        if temp[user_id]['count_item'] == 0 or len(temp[user_id]['bag']) == int(_skill['bag']):
            if len(temp[user_id]['bag']) == 0:
                text = '–¢—ã –≤–µ—Ä–Ω—É–ª—Å—è –¥–æ–º–æ–π —Å –ø—É—Å—Ç—ã–º–∏ —Ä—É–∫–∞–º–∏.\n–ù–∏—á–µ–≥–æ, –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ –±—É–¥–µ—Ç –ª—É—á—à–µ.'
            else:
                text = '–¢—ã –ø—Ä–∏–Ω–µ—Å –¥–æ–º–æ–π —Å–ª–µ–¥—É—é—â–∏–µ –ø—Ä–µ–¥–º–µ—Ç—ã:\n'
                _data = {}
                for _item in temp[user_id]['bag']:
                    if _item in _data:
                        _data[_item] += 1
                    else:
                        _data[_item] = 1
                for _item in _data:
                    text += '{} x{}\n'.format(names.item[_item], _data[_item])
                if temp[user_id]['gold'] != 0:
                    text += '\n{}üí∞'.format(temp[user_id]['gold'])
            send_message(user_id, text, get_start_button(user_id))
            temp[user_id] = {}
            return

        temp[user_id]['count_item'] -= 1
        text = random.choice(names.advent_text['mount'])
        send_message(user_id, text)
        print ('user_id : ' + str(user_id) + ' | Action: Get /catch | Time : ' + str(time.time()))
        print ('|--------------------|')
        set_hand(user_id, mount_adventure.item_handler)
        bd_adventure2.append(['mount_adventure.random_item', int(_skill['time']), [user_id]])

    @staticmethod
    def item_timer(user_id):
        set_hand(user_id, mount_adventure.mount_handler)
        time = random.randint(40, 150)
        bd_adventure2.append(['mount_adventure.random_item', time, [user_id]])

    @staticmethod
    def item_handler(user_id, message):
        if message.lower() == '/catch':
            _quest = db.get_quest(user_id)
            _store = db.get_user_inventory(user_id)
            set_hand(user_id, mount_adventure.mount_handler)
            random_item = get_adv_item('mount', user_id)

            if _quest['quest'] == 'start_23' and random.random() < 0.1 and int(_store['logic']) < 1:
                text = '–í–Ω–µ–∑–∞–ø–Ω–æ –≤—ã —Ä–µ—à–∏–ª–∏ –ø–æ–∏—Å–∫–∞—Ç—å –ª–æ–≥–∏–∫—É, –Ω–æ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã—à–ª–æ. –í–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ—Å—å –≤ –¢–∞–≤–µ—Ä–Ω—É.'
                db.add_inventory(user_id, 'logic', 1)
                send_message(user_id, text)
                return

            if (random.random() < 0.05):
                _quest = db.get_quest(user_id)
                if _quest['item'] != random_item:
                    text = '–¢—ã –Ω–∞—à–µ–ª **{}**, –Ω–æ –æ–Ω —Ä–∞—Å—Å—ã–ø–∞–ª—Å—è –ø—Ä—è–º–æ —É —Ç–µ–±—è –≤ —Ä—É–∫–∞—Ö.\n–°–º–∞—Ö–Ω—É–≤ —Å–ª–µ–∑—É, —Ç—ã —Ä–µ—à–∏–ª –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ.'.format(names.item[random_item])
                    send_message(user_id, text, parse_mode = 'Markdown')
                    return
                pass

            if random.random() < 0.35:
                mob = get_adv_mob('mount', user_id)
                monster_battle(user_id, mob)
                return
            text = random.choice(names.advent_text['item']).format(names.item[random_item])
            if random.random() < 0.15:
                text = random.choice(names.advent_text['diamond_item']).format(names.item[random_item])
                send_sticker(user_id, 'CAADAgADXwADP1c0Gk1PS2oDPWnTAg')
                i_get_diamond(user_id, 1)
            if random.random() > 0.8:
                _gold = i_get_gold(user_id)
                text += '\n–¢–∞–∫–∂–µ —Ç—ã –Ω–∞—à–µ–ª –ø–æ–¥ –Ω–æ–≥–∞–º–∏ {}üí∞.'.format(_gold)
                temp[user_id]['gold'] += _gold
            send_message(user_id, text, parse_mode = 'Markdown')
            temp[user_id]['bag'].append(random_item)
            db.add_inventory(user_id, random_item, 1)
        elif message.lower() == '–≤–µ—Ä–Ω—É—Ç—å—Å—è –¥–æ–º–æ–π':
            temp[user_id]['count_item'] = 0
            text = '–¢—ã –≤—ã–¥–≤–∏–Ω—É–ª—Å—è –¥–æ–º–æ–π.'
            send_message(user_id, text, parse_mode = 'Markdown')
        else:
            return

    @staticmethod
    def mount_handler(user_id, message):
        if message == '/catch':
            text = random.choice(names.advent_text['not_item'])
        elif message.lower() == '–æ–∂–∏–¥–∞—Ç—å':
            text = '–ù—É —Ç—ã –æ–∂–∏–¥–∞–µ—à—å, –Ω–æ –ø–æ–∫–∞ —É—Å–ø–µ—Ö–æ–≤ —ç—Ç–æ —Ç–µ–±–µ –Ω–µ –¥–∞–ª–æ.'
        elif message.lower() == '–≤–µ—Ä–Ω—É—Ç—å—Å—è –¥–æ–º–æ–π':
            text = '–¢—ã –≤—ã–¥–≤–∏–Ω—É–ª—Å—è –¥–æ–º–æ–π.'
            temp[user_id]['count_item'] = 0
        else:
            return
        send_message(user_id, text)








class desert_adventure():

    @staticmethod
    def enter(user_id):
        temp[user_id] = {}
        _skill = db.get_skill(user_id)
        temp[user_id]['count_item'] = round(int(_skill['bag']) * 1,5)
        temp[user_id]['bag'] = []
        temp[user_id]['gold'] = 0
        temp[user_id]['dungeon'] = False
        desert_adventure.item_timer(user_id)
        _skill = db.get_skill(user_id)
        text = '–¢—ã —É—à–µ–ª –ø—Ä–æ–≥—É–ª—è—Ç—å—Å—è –ø–æ–¥ –ø–æ–ª—è—â–∏–º —Å–æ–ª–Ω—Ü–µ–º –ø—É—Å—Ç—ã–Ω–∏. –ù–∞–¥–µ—é—Å—å, —á—Ç–æ –≤—ã–π–¥–µ—à—å –æ—Ç—Ç—É–¥–∞ –Ω–µ —Å –ø—É—Å—Ç—ã–º–∏ —Ä—É–∫–∞–º–∏.'
        button = [['–û–∂–∏–¥–∞—Ç—å'], ['–í–µ—Ä–Ω—É—Ç—å—Å—è –¥–æ–º–æ–π']]
        send_message(user_id, text, button)

    @staticmethod
    def random_item(user_id):
        _skill = db.get_skill(user_id)
        if temp[user_id]['dungeon'] == True:
            return
        if temp[user_id]['count_item'] == 0:
            text = '–¢—ã –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–∞–¥, —á—Ç–æ —Å–º–æ–≥ –≤–µ—Ä–Ω—É—Ç—å—Å—è –¥–æ–º–æ–π –∂–∏–≤—ã–º.'
            send_message(user_id, text, get_start_button(user_id))
            temp[user_id] = {}
            return

        temp[user_id]['count_item'] -= 1
        text = random.choice(names.advent_text['desert'])
        send_message(user_id, text)
        print ('user_id : ' + str(user_id) + ' | Action: Get /catch | Time : ' + str(time.time()))
        print ('|--------------------|')
        set_hand(user_id, desert_adventure.item_handler)
        bd_adventure2.append(['desert_adventure.random_item', int(_skill['time']), [user_id]])

    @staticmethod
    def item_timer(user_id):
        if temp[user_id]['dungeon'] == True:
            return
        _skill = db.get_skill(user_id)
        set_hand(user_id, desert_adventure.desert_handler)
        time = random.randint(40, 150)
        bd_adventure2.append(['desert_adventure.random_item', time, [user_id]])

    @staticmethod
    def item_handler(user_id, message):
        if message.lower() == '/catch':
            set_hand(user_id, desert_adventure.desert_handler)

            if (random.random() < 0.05 or random.random() > 0.95):
                text = '–ú–æ–Ω—Å—Ç—Ä –±—ã–ª –ª–∏—à—å –º–∏—Ä–∞–∂–æ–º, –º–æ–≥ –∏ –Ω–µ –ø–æ–¥–Ω–∏–º–∞—Ç—å —Ç–∞–∫ –≤—ã—Å–æ–∫–æ —Å–≤–æ–π –º–µ—á.'
                send_message(user_id, text, parse_mode = 'Markdown')
                return
                
            if random.random() < 0.25:
                print ('user_id : ' + str(user_id) + ' | Action: Get Dungeon | Time : ' + str(time.time()))
                print ('|--------------------|')
                temp[user_id]['dungeon'] = True
                unknown_dungeon().on_entry(user_id)
                set_hand(user_id, unknown_dungeon().handler)
                return

            mob = get_adv_mob('desert', user_id)
            monster_battle(user_id, mob)
        else:
            return

    @staticmethod
    def desert_handler(user_id, message):
        if message == '/catch':
            text = random.choice(names.advent_text['not_item'])
        elif message.lower() == '–æ–∂–∏–¥–∞—Ç—å':
            text = '–ù—É —Ç—ã –æ–∂–∏–¥–∞–µ—à—å, –Ω–æ –ø–æ–∫–∞ —É—Å–ø–µ—Ö–æ–≤ —ç—Ç–æ —Ç–µ–±–µ –Ω–µ –¥–∞–ª–æ.'
        elif message.lower() == '–≤–µ—Ä–Ω—É—Ç—å—Å—è –¥–æ–º–æ–π':
            text = '–¢—ã –≤—ã–¥–≤–∏–Ω—É–ª—Å—è –¥–æ–º–æ–π.'
            temp[user_id]['count_item'] = 0
        else:
            return
        send_message(user_id, text)
